{"meta":{"title":"Guardian NixOS Security Hardening Plan","date":"2026-02-07","audience":"Security Team","purpose":"Hardening plan for NixOS configuration to eliminate sensitive data in repo and enforce runtime secret injection","repo_root":"/home/rumi/Projects/guardian-core","status":"IN_PROGRESS","format":"dense-json","references":{"security_docs":["docs/security/secrets_management.json","docs/security/security_policy.json","docs/security/security_checklist.json","docs/security/incident_response.json","docs/security/threat_model.json","docs/security/waivers.json","docs/security/network_defense.json"],"nix_files":["infra/nixos/configuration.nix","infra/nixos/hardware-configuration.nix","infra/nixos/services/guardian-core.nix","infra/nixos/services/rumi-platform.nix","infra/nixos/services/server.nix"],"examples":["config-examples/nixos/private.nix","config-examples/nixos/hardware-configuration.private.nix"]}},"constraints":{"security_invariants":["SP-SECRET-001","SP-SECRET-002","SP-SECRET-003"],"secrets_management_invariants":["No plaintext repository secret storage","Platform-backed runtime storage and controlled CI custody","Mandatory defense-in-depth, not optional linting"],"operational_modes":["MODE_HIGH_ASSURANCE","MODE_DEVELOPER"],"fail_closed":"Missing private config or missing encrypted secrets must block builds/deploys","non_waivable_controls":["SP-SECRET-001","SP-SECRET-002"]},"scope":{"hosts":["rumi-vps"],"areas":["NixOS system configuration","NixOS hardware configuration","service environment injection","secret storage and encryption","CI/release guardrails"],"non_goals":["Changing service behavior beyond env injection","Rotating unrelated non-Nix secrets","Re-architecting app runtime"]},"risk_assessment":{"current_exposures":[{"id":"RISK-SSH-KEYS","desc":"SSH public keys and host identifiers in repo leak infrastructure metadata"},{"id":"RISK-DOMAIN","desc":"Public domain routing in repo reveals service endpoint"},{"id":"RISK-HARDWARE","desc":"Disk/boot device and kernel module list in repo reveal host topology"},{"id":"RISK-ENV","desc":"Service env file path implies plaintext secret storage"}],"impact":"Metadata exposure + potential secret sprawl; violates SP-SECRET-001/003","likelihood":"Medium","priority":"High"},"decision":{"secret_tool":"sops-nix","rationale":["Aligns with NixOS + systemd-creds runtime injection model","Supports encrypted files committed to repo without plaintext","Flexible formats (dotenv) and access control","Operationally standard for NixOS"],"rejected_alternatives":[{"name":"agenix","reason":"Valid but less aligned with documented systemd-creds preference and dotenv use; sops-nix offers richer file format support and validation"}],"policy_alignment":{"sops_nix_vs_systemd_creds":{"action":"Update secrets_management.json to explicitly approve sops-nix for NixOS or document equivalence to systemd-creds","owner":"security","required":true},"crypto_scope":{"action":"Document that age/sops encryption is at-rest and out of scope for Tier2+ runtime crypto policy, or update policy scope","owner":"security","required":true}}},"plan":{"phases":[{"id":"PHASE-1","name":"Repo Restructure (Public vs Private)","objective":"Remove sensitive data from tracked Nix files","steps":[{"id":"P1-S1","action":"Create private modules","details":{"paths":["infra/nixos/private.nix","infra/nixos/hardware-configuration.private.nix"],"source_templates":["config-examples/nixos/private.nix","config-examples/nixos/hardware-configuration.private.nix"],"owner":"ops","controls":["SP-SECRET-001"],"failure_mode":"Missing file must fail Nix evaluation"}},{"id":"P1-S2","action":"Make public modules fail closed","details":{"files":["infra/nixos/configuration.nix","infra/nixos/hardware-configuration.nix"],"mechanism":"assert builtins.pathExists ./private.nix and ./hardware-configuration.private.nix","expected_outcome":"Nix evaluation fails with explicit error if private files missing"}},{"id":"P1-S3","action":"Remove sensitive literals from repo","details":{"removed_fields":["networking.hostName","openssh.authorizedKeys.keys","caddy virtual host domains","boot device/fs config"],"destination":"private.nix or hardware-configuration.private.nix"}}]},{"id":"PHASE-2","name":"Secrets Encryption and Runtime Injection","objective":"Ensure all service environment variables are encrypted-at-rest and injected at runtime","steps":[{"id":"P2-S1","action":"Add sops-nix flake input","details":{"file":"flake.nix","input":"sops-nix","nixosModules":"sops-nix.nixosModules.sops","lockfile":"flake.lock","controls":["SP-SECRET-003","SP-SECRET-001"],"validation":"nix flake check (optional)"}},{"id":"P2-S2","action":"Define SOPS configuration in private module","details":{"file":"infra/nixos/private.nix","settings":["sops.defaultSopsFile","sops.age.keyFile","sops.validateSopsFiles"],"key_storage":"/var/lib/sops-nix/key.txt","access":"root only","rotation":"90d default"}},{"id":"P2-S3","action":"Create encrypted dotenv secrets","details":{"files":["infra/nixos/secrets/guardian-core.env","infra/nixos/secrets/rumi-platform.env","infra/nixos/secrets/rumi-server.env"],"format":"dotenv","encryption":"age recipients","ownership":{"user":"rumi","group":"users","mode":"0400"},"injection":"config.sops.secrets.<name>.path"}},{"id":"P2-S4","action":"Update systemd services to consume SOPS secrets","details":{"files":["infra/nixos/services/guardian-core.nix","infra/nixos/services/rumi-platform.nix","infra/nixos/services/server.nix"],"change":"EnvironmentFile points to config.sops.secrets.<name>.path","guard":"throw on missing secret","controls":["SP-SECRET-003","SP-SECRET-001"]}},{"id":"P2-S5","action":"Verify service users match secret file ownership","details":{"files":["infra/nixos/services/guardian-core.nix","infra/nixos/services/rumi-platform.nix","infra/nixos/services/server.nix"],"check":"service User matches secret owner/group","controls":["SP-SECRET-003"]}}]},{"id":"PHASE-3","name":"Guardrails and Auditability","objective":"Prevent regressions and ensure evidence","steps":[{"id":"P3-S1","action":"Git ignore private files","details":{"file":"infra/nixos/.gitignore","entries":["private.nix","hardware-configuration.private.nix"],"control":"SP-SECRET-001"}},{"id":"P3-S2","action":"Add repo secret scanning gate","details":{"gate":"gitleaks detect --no-git --redact --exit-code 1","existing_policy":"SP-GATE-SECRETS in docs/security/security_policy.json","enforcement":"CI/release blocking"}},{"id":"P3-S3","action":"Document sops-nix bootstrap procedure","details":{"location":"docs/security or ops runbook","content":["age key generation","recipient distribution","sops file creation","nixos-rebuild procedures"],"evidence":"runbook update commit"}}]},{"id":"PHASE-4","name":"Checklist Integration and Evidence","objective":"Make hardening verifiable by existing policy gates","steps":[{"id":"P4-S1","action":"Add NixOS secrets checks to security checklist","details":{"file":"docs/security/security_checklist.json","checks":["CHK-NIXOS-SECRETS-01","CHK-NIXOS-SECRETS-02","CHK-NIXOS-SECRETS-03","CHK-NIXOS-SECRETS-04"],"gate_id":["SP-SECRET-001","SP-SECRET-002","SP-SECRET-003"]}},{"id":"P4-S2","action":"Ensure merge gate requires NixOS secrets checks","details":{"gate":"CHK-GATE-07","verification":"passing evidence artifacts"}},{"id":"P4-S3","action":"Generate evidence artifacts","details":{"artifacts":["artifacts/security/CHK-NIXOS-SECRETS-01.json","artifacts/security/CHK-NIXOS-SECRETS-02.json","artifacts/security/CHK-NIXOS-SECRETS-03.json","artifacts/security/CHK-NIXOS-SECRETS-04.json"],"format":"JSON evidence with hashes + timestamps"}}]},{"id":"PHASE-5","name":"SP-SECRET-002 Log/Artifact Redaction","objective":"Prevent secret leakage in logs, errors, or artifacts","steps":[{"id":"P5-S1","action":"Add log redaction verification","details":{"scope":["systemd journal","service log files","release artifacts"],"method":"scan for secret patterns and known values; verify SecretRedactor coverage","controls":["SP-SECRET-002"]}},{"id":"P5-S2","action":"Add negative tests for secret exposure","details":{"method":"inject test sentinel secrets and confirm redaction","controls":["SP-SECRET-002"]}}]},{"id":"PHASE-6","name":"Policy Alignment and Crypto Scope","objective":"Resolve policy inconsistencies introduced by sops-nix and age","steps":[{"id":"P6-S1","action":"Update secrets_management.json storage model","details":{"file":"docs/security/secrets_management.json","change":"Add sops-nix as approved NixOS mechanism or explicit equivalence to systemd-creds","controls":["SP-SECRET-003"]}},{"id":"P6-S2","action":"Document crypto policy scope","details":{"file":"docs/security/security_policy.json","change":"Clarify Tier2+ crypto policy applies to runtime/authority paths; at-rest secret encryption uses age and is scoped separately","controls":["SP-CRYPTO-001"]}}]},{"id":"PHASE-7","name":"Key Custody Hardening","objective":"Ensure age key storage meets secure custody requirements","steps":[{"id":"P7-S1","action":"Harden key storage","details":{"key_file":"/var/lib/sops-nix/key.txt","options":["TPM-backed key","YubiKey age-plugin","LUKS-encrypted root"],"requirement":"document chosen custody model","controls":["SP-SECRET-003"]}},{"id":"P7-S2","action":"Encrypted backup and recovery plan","details":{"backup":"encrypted offline backup stored in secure vault","rotation":"align with 90d policy","controls":["SP-SECRET-003"]}}]},{"id":"PHASE-8","name":"Atomic Cutover","objective":"Avoid non-waivable control violation during transition","steps":[{"id":"P8-S1","action":"Atomic migration strategy","details":{"method":"single deploy that removes plaintext and adds sops-nix in one change","prohibition":"no intermediate commits with secrets in tracked files","controls":["SP-SECRET-001"]}},{"id":"P8-S2","action":"Pre-merge check","details":{"check":"gitleaks + rg patterns against infra/nixos public files","enforcement":"block merge if matches","controls":["SP-SECRET-001"]}}]},{"id":"PHASE-9","name":"Dependency Policy Acknowledgment","objective":"Treat sops-nix addition as security-relevant","steps":[{"id":"P9-S1","action":"Dependency review and license scan","details":{"controls":["SP-DEP-002","SP-DEP-003"],"evidence":"artifacts/security/CHK-SUPPLY-CHAIN-04.json"}}]},{"id":"PHASE-10","name":"Incident Response Alignment","objective":"Align rollback with IR playbooks","steps":[{"id":"P10-S1","action":"Bind rollback to IR-SECRET-LEAK","details":{"playbook":"IR-SECRET-LEAK","actions":["Revoke leaked credentials","Rotate adjacent credentials","Audit access/usage logs","Preserve evidence and incident timeline"],"checks":["Confirm no secrets in logs/artifacts"],"controls":["SP-SECRET-002"]}}]}]},"implementation_details":{"file_map":{"public_nix_files":["infra/nixos/configuration.nix","infra/nixos/hardware-configuration.nix"],"private_nix_files":["infra/nixos/private.nix","infra/nixos/hardware-configuration.private.nix"],"services":["infra/nixos/services/guardian-core.nix","infra/nixos/services/rumi-platform.nix","infra/nixos/services/server.nix"],"examples":["config-examples/nixos/private.nix","config-examples/nixos/hardware-configuration.private.nix"],"secrets_dir":"infra/nixos/secrets"},"sops_nix":{"key_management":{"key_file":"/var/lib/sops-nix/key.txt","permissions":"0400 root:root","creation":"age-keygen -o /var/lib/sops-nix/key.txt","recipient":"age public key exported for sops"},"sops_yaml":{"fields":["sops.age","mac","lastmodified","version"],"recipients":"age keys of operators + host key"},"dotenv_layout":{"guardian_core_env":["CLAUDE_CODE_OAUTH_TOKEN"],"platform_env":["DATABASE_URL","SECRET_KEY_BASE","PHX_HOST"],"server_env":["WEBHOOK_SECRET","PORT"]},"validation":{"validateSopsFiles":true}},"access_controls":{"principle":"least privilege","service_user":"rumi","secret_file_owner":"rumi","secret_file_mode":"0400","root_only_key":"/var/lib/sops-nix/key.txt"}},"verification":{"checks":[{"id":"V1","type":"static","command":"rg -n \"authorizedKeys.keys|hostName|self.rumi.engineering|/dev/sda\" infra/nixos","expect":"no matches in public files"},{"id":"V2","type":"nix-eval","command":"nix eval .#nixosConfigurations.rumi-vps.config.sops.secrets.guardian-core-env.path","expect":"path exists"},{"id":"V3","type":"runtime","command":"systemctl status guardian-core rumi-platform rumi-server","expect":"active (running)"},{"id":"V4","type":"secrets","command":"sudo ls -l $(nix eval --raw .#nixosConfigurations.rumi-vps.config.sops.secrets.guardian-core-env.path)","expect":"mode 0400 owner rumi"},{"id":"V5","type":"scan","command":"gitleaks detect --no-git --redact --exit-code 1","expect":"exit 0"},{"id":"V6","type":"log-redaction","command":"journalctl -u guardian-core -u rumi-platform -u rumi-server --since -24h | rg -n '(_KEY=|_TOKEN=|_SECRET=|_PASSWORD=)'","expect":"no matches"},{"id":"V7","type":"checklist","command":"jq -r '.security_checklist.sections[].checks[].evidence_artifact' docs/security/security_checklist.json | xargs -n1 test -f","expect":"all evidence artifacts present"},{"id":"V8","type":"policy","command":"rg -n \"sops-nix\" docs/security/secrets_management.json","expect":"policy aligned to chosen mechanism"},{"id":"V9","type":"crypto-scope","command":"rg -n \"at-rest|age\" docs/security/security_policy.json","expect":"crypto scope documented"},{"id":"V10","type":"custody","command":"test -f /var/lib/sops-nix/key.txt && sudo ls -l /var/lib/sops-nix/key.txt","expect":"restricted permissions and documented backup"}]},"rollback":{"criteria":["sops key loss without backup","service fails to start after deploy","evidence of secret leakage"],"reference":{"playbook":"IR-SECRET-LEAK","file":"docs/security/incident_response.json"},"steps":[{"id":"RB1","action":"Revoke leaked credentials immediately","notes":"Per IR-SECRET-LEAK"},{"id":"RB2","action":"Rotate related credentials to reduce dwell time","notes":"Per IR-SECRET-LEAK"},{"id":"RB3","action":"Audit for misuse and unauthorized access","notes":"Per IR-SECRET-LEAK"},{"id":"RB4","action":"Preserve evidence and timeline; remediate repo/artifacts","notes":"Per IR-SECRET-LEAK"}],"approval_required":true},"audit":{"evidence_artifacts":["git diff showing removal of sensitive literals","SOPS-encrypted files in infra/nixos/secrets","systemd status outputs","gitleaks scan output","artifacts/security/CHK-NIXOS-SECRETS-01.json","artifacts/security/CHK-NIXOS-SECRETS-02.json","artifacts/security/CHK-NIXOS-SECRETS-03.json","artifacts/security/CHK-NIXOS-SECRETS-04.json"],"audit_questions":["Are any secrets or host identifiers present in tracked Nix files?","Are service env files encrypted at rest and injected at runtime?","Is the repo protected by mandatory scanning gates?","Are key custody and rotation documented and enforced?","Are NixOS infra secrets checks in the security checklist with evidence artifacts?","Are systemd journal and service logs verified free of secret leakage?","Is sops-nix explicitly approved in secrets_management.json or equivalently mapped?","Is the sops/age key custody model documented and backed up?","Was the migration performed as an atomic cutover without interim plaintext commits?"],"owner":"Root human operator","review_cadence":"Monthly or post-incident"},"deliverables":["Updated NixOS configuration with private modules","sops-nix integrated into flake","Encrypted dotenv files for all services","Updated guardrails and docs"],"status_tracking":{"current_repo_state":"Code changes complete. Policy docs updated. Services hardened. Awaiting operator actions on host.","completed_phases":{"PHASE-1":"COMPLETE — Public modules fail-closed; sensitive literals removed; private module templates exist","PHASE-2_code":"COMPLETE — Services use sops secrets with throw guard; sops-nix in flake; systemd hardening added","PHASE-3":"COMPLETE — .gitignore set; SP-GATE-SECRETS exists; bootstrap runbook added to orchestration_runbook.json (RUNBOOK-SOPS-BOOTSTRAP)","PHASE-4_checklist":"COMPLETE — CHK-NIXOS-SECRETS-01..04 and CHK-GATE-07 added to security_checklist.json","PHASE-5_code":"COMPLETE — systemd hardening (NoNewPrivileges, PrivateTmp, ProtectSystem, ProtectHome) added to all 3 service files","PHASE-6":"COMPLETE — secrets_management.json updated for sops-nix; security_policy.json crypto scope documented","PHASE-10":"COMPLETE — IR-NIXOS-SECRET-LEAK playbook added to incident_response.json; RUNBOOK-RECOVERY-05 added"},"remaining_operator_actions":["Create actual private.nix and hardware-configuration.private.nix on host from templates","Generate age key on host (see RUNBOOK-SOPS-BOOTSTRAP)","Create and encrypt dotenv secrets with sops","Execute atomic cutover deploy (nixos-rebuild switch)","Run V1-V10 verification checks post-deploy","Generate evidence artifacts for CHK-NIXOS-SECRETS-01..04","Choose and document age key custody model (PHASE-7: TPM/YubiKey/LUKS)","Create encrypted offline backup of age key","Record sops-nix dependency review for SP-DEP-002/003 (PHASE-9)"]},"threat_model_mapping":[{"risk_id":"RISK-SSH-KEYS","threats":["TM-CLASS-04","THR-CONF-01","THR-CONF-02"]},{"risk_id":"RISK-DOMAIN","threats":["THR-CONF-01"]},{"risk_id":"RISK-HARDWARE","threats":["THR-CONF-01"]},{"risk_id":"RISK-ENV","threats":["TM-CLASS-04","THR-CONF-02"]}]}